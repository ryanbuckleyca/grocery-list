<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>311 Grocery List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="style.css" />
    <script src="https://kit.fontawesome.com/a367e5e4f1.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <script type="text/javascript">

      function getList() {
        let data = null
        let xmlhttp = new XMLHttpRequest()
        xmlhttp.open("GET", "/foodItems", false)
        xmlhttp.send()
        if (xmlhttp.status==200) { data = xmlhttp.responseText }
        return JSON.parse(data)
      }

      function sendToApp(action, url, data) {
        var xmlhttp = new XMLHttpRequest() 
        xmlhttp.open(action, url)
        xmlhttp.setRequestHeader("Content-Type", "application/json")
        
        xmlhttp.send(JSON.stringify(data))
      }

      function deleteItem(itemID) {
        if(!confirm("Delete?")) return 
        sendToApp("DELETE", "/foodItems/" + itemID, { "id": itemID})

        let element = document.getElementById("groceryRow-" + itemID)
        element.parentNode.removeChild(element)
      }

      function toggleStatus(id) {
        if(document.getElementById("statusButton-" + id)
          .contentEditable === "true") //attribute value is string, not boolean
          return //do not toggle status...user is editing value
        //quit if Name is being edited

        let newStatus = document.getElementById("statusButton-" + id).className
        switch(newStatus) {
          case "groceryItem out": 
            newStatus = "GOOD" 
            document
              .getElementById("statusButton-" + id)
              .classList.replace("out", "good")
            break
          case "groceryItem good": 
            newStatus = "LOW" 
            document
              .getElementById("statusButton-" + id)
              .classList.replace("good", "low")
            break
          case "groceryItem low": 
            newStatus = "OUT" 
            document
              .getElementById("statusButton-" + id)
              .classList.replace("low", "out")
            break
        }
        sendToApp("PUT", "/foodItems/" + id, { "status": newStatus})
      }

      function editItem(itemID) {
        //TODO: 
        //deactivate edit button
        //how to keep it deactive as a space to click to exit Edit box
        //Edit box is active
        // document.getElementById("editButton-" + itemID).onclick = null

        //make element editable and put cursor inside
        document.getElementById("statusButton-" + itemID)
          .contentEditable = true
        document.getElementById("statusButton-" + itemID)
          .focus()
        document.getElementById("statusButton-" + itemID)
          .classList.add("edit")

      }

      function sendOnEnter (event, id) {
        if (event.which == 13 || event.keyCode == 13) {
          //enter has been pressed, send data
          sendEditedItem(id)
        }
      }

      function sendEditedItem(itemID) {
        //TODO:
        //triggered when Edit box is unfocused
        //we want mousedown to not trigger button
        //sets button onclick active again
        //so by the time we click on button again it's already reactivated
        // document.getElementById("editButton-" + itemID)
        //   .onclick = function(){editItem(itemID)}


        document.getElementById("statusButton-" + itemID)
          .contentEditable = false
        document.getElementById("statusButton-" + itemID)
          .classList.remove("edit")


        let newName = document.getElementById("itemName-" + itemID + "p").innerText
        
        sendToApp("PUT", "/foodItems/" + itemID, { "id": itemID, "name": newName})
      }

      function addItem() {
        var name = prompt("Enter the name of the item:")
        var cat = prompt("Enter the category for " + name)

        sendToApp("POST", "/foodItems", { "name": name, "category": cat})
      }

      const foodItems = getList()

      //<div id="groceryList">
      let node = document.createElement("div")
      node.id = "groceryList"
      node.className = "container-fluid p-0"
      document.getElementsByTagName("body")[0].appendChild(node)

      let lastCat = ""
      //print each line of the list
      for(let i = 0; i < foodItems.length; i++) { 
        let itemData = foodItems[i]
        //print a category header    
        if (itemData.category !== lastCat) {
          node = document.createElement("div")
          node.id = itemData.category
          node.className = "groceryHeader row no-gutters text-center"
          node.innerHTML = "<div class=\"col-12\">" + itemData.category +"</div>"
          document.getElementById("groceryList").appendChild(node)
        } 
        lastCat = itemData.category

        //<div id="groceryRow" class="groceryRow">
        node = document.createElement("div")
        node.id = "groceryRow-" + itemData.id
        node.className = "groceryRow row no-gutters text-center"
        document.getElementById("groceryList").appendChild(node)

        //DEL ITEM
          //<div id="delItem0" class="delItem">
          node = document.createElement("div")
          node.id = "delItem-" + itemData.id
          node.className = "delItem col-2 text-center align-self-center"
          document.getElementById("groceryRow-" + itemData.id).appendChild(node)

            //<button onclick="deleteItem(22)">
            node = document.createElement('button')
            node.id = "delButton-" + itemData.id
            node.onclick = function(){deleteItem(itemData.id)}
            document.getElementById("delItem-" + itemData.id).appendChild(node)

              //<i class="far fa-trash-alt" aria-hidden="true"></i>
              node = document.createElement('li')
              node.className = "far fa-trash-alt"
              node.ariaHidden = true
              document.getElementById("delButton-" + itemData.id).appendChild(node)

        //GROCERY NAME
        //TODO: figure out why this is getting pushed left into preceding column
          //<div id="itemName:id" class="groceryName ...">
          node = document.createElement("div")
          node.id = "itemName-" + itemData.id
          node.className = "groceryName col-8 p-2 text-center align-self-center"
          document.getElementById("groceryRow-" + itemData.id).appendChild(node)

            //<button id="item0name" class="groceryItem out">
              //<p>Soy Milk</p>
            node = document.createElement("button")
            node.id = "statusButton-" + itemData.id
            node.onblur = function(){sendEditedItem(itemData.id)}
            switch(itemData.status){
              case "GOOD": node.className = "groceryItem good"; break
              case "LOW": node.className = "groceryItem low"; break
              case "OUT": node.className = "groceryItem out"; break
              default: node.className = "groceryItem out"; break
            }
            node.contentEditable = false
            node.onclick = function(){
              toggleStatus(itemData.id, itemData.status)
              }
            node.innerHTML = "<p id=\"itemName-" + itemData.id+ "p\">" + itemData.name + "</p>"

            node.onkeydown = function(event){
              if (event.which == 13 || event.keyCode == 13) {
                event.preventDefault()
                sendEditedItem(itemData.id)
              }
            }

            document.getElementById("itemName-" + itemData.id).appendChild(node)

        //EDIT ITEM
          //<div id="editItem0" class="editItem">
          node = document.createElement("div")
          node.id = "editItem-" + itemData.id
          node.className = "editItem col-2 text-center align-self-center"
          document.getElementById("groceryRow-" + itemData.id).appendChild(node)

            //<button id="editButton1" onclick="editItem(22, 'Soy%20Milk')">
            node = document.createElement('button')
            node.id = "editButton-" + itemData.id
            node.onclick = function(){editItem(itemData.id)}
            document.getElementById("editItem-" + itemData.id).appendChild(node)
            
              //<i class="far fa-edit" aria-hidden="true"></i>
              node = document.createElement('li')
              node.className = "far fa-edit"
              node.ariaHidden = true
              document.getElementById("editButton-" + itemData.id).appendChild(node)

      }
      
      //tack on the Add Item button
      node = document.createElement("div")
      node.id = "addItem"
      node.className = "addItem"
      node.onclick = function(){addItem()}
      node.innerHTML = "<button><i class=\"fas fa-cart-plus\"></i></button>"
      document.getElementsByTagName("body")[0].appendChild(node)

      </script>  
      
  </body>
</html>